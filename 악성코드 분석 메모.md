시나리오
피해자의 컴퓨터 배경화면이 바뀌고 파일이 열리지 않음. -> 랜섬웨어 가능성
피해자는 웹서핑 중이었음. -> DBD 가능성


192.168.200.47

 

<침해사고  PC 조사>
1. 인터뷰 후 파일경로 확인
C:\Users\Administrator\AppData\Local\Microsoft\Windows\Temporary Internet Files


2. 타임라인 분석
-> READ_IT.txt(랜섬노트) 수정한 날짜 확인
-> html, js 파일 추출

+ 새폴더로 백업 
내 컴퓨터에서 수정된 날짜 "2019-07-18" 검색

 

3. 악성 스크립트 추출
-> findstr /s "eval(" *.js > result.txt                          /js 파일을 result.txt에 추출하여 출력


4. 악성자바스크립트 분석
-> https://beautifier.io                                               /악성자바스크립트를 가독성이 좋도록 코드 정렬
-> 콘솔창에서 자바스크립트 붙여넣기가 안 되는 경우
-> 개발자도구(F12) -> F1 -> Threat code evaluation as user action 확인

 

 

(숨김 파일 표시)
svchost.exe
local


악성코드에서 entropy(엔트로피)는 난독화 여부를 봄.
4점 이상 ~5점대 부분 난독화
7점 이상 ~8점대 난독화

난독화: 코드 난독화는 프로그래밍 언어로 작성된 코드에 대해 읽기 어렵게 만드는 작업.
감시나 데이터 수집을 방해하기 위해 모호하거나 헷갈리거나 호도하는 정보를 고의적으로 섞어 넣는 것을 말함.
대표적인 사용 예로는 프로그램에서 사용된 아이디어나 알고리즘 등을 숨기는 것 등. 


<악성코드 분석>

pestudio - 518.exe 파일 오픈

<설정>
자동 업데이트 사용하지 않음
사용자 계정 컨트롤 설정 낮추기
방화벽 해제

cmd - 관리자 권한 실행 
C:\Users\kisec_edu\Desktop>sysmon.exe -i -n -h sha256

- 악성코드 유사성 해시: imphash, ssdeep
- 프로그램이 동작할 때 꼭 필요한 라이브러리: kenrner32.dll, user32.dll, ntdll.dll
CF) GetProcAddress(), VirtualAlloc(), LoadLibraryA()
- 윈도우 기반 메모리 구조
stack - heap - program image(text, data, ...) - 비할당된 영역 - DLL - TEB - PEB
CF) TEB(Thread Environment Block), PEB(Process Enviroment Block)

- 악성코드 동적 분석

Sysmon
Regshot
Procmon
518
Autoruns
proexp

 

의심되는 동작 프로세스를 확인하기 전 기본 윈도우 프로세스를 알아야 함.

기본적으로 동작하는 윈도우 프로세스

 

System
csrss.exe
wininit.exe
services.exe
svchost.exe
winlogin.exe
explorer.exe

etc

부모 프로세스 - 자식 프로세스 간의 관계를 알아야 함.

의심되는 프로세스
cmd.exe - 윈도우 밖에서 동작
conhost.exe를 꺼도 독립적으로 실행

cmd.exe -> Create Full Dump -> cmd.dmp 저장


DLL Injection : 다른 프로세스에 특정 DLL 파일을 강제로 삽입시키는 것임.

result.txt 도메인에 은행 관련 도메인이 많은 것을 보고 인포스틸러, banker일 가능성이 있음.

 

 

(1) Sysmon
cmd(관리자 권한)- "sysmon.exe -i -n -h sha256"
로그 확인: 이벤트 뷰어 - 응용프로그램 및 서비스 로그 - Microsoft - Windows - Sysmon - Operational

ID 1: Process Create
ID 5: Process Terminate
ID 3: Network Connection

 

 

(2) Promon
AutoScroll 버튼 활성화(새로운 이벤트 실시간 확인)

<메모리에서 문자열 지표 찾기>
공격자의 IP 혹은 도메인 (필요)
- strings cmd.dmp | findstr /i /r .*\..*\..*\..* > result.txt         (cmd)

<Promon으로 이벤트 찾기>
필터 규칙
-> Column 이름(PID, Operation 등) 동일한 경우
여러 규칙들이 OR
-> Column 이름(PID, Operation 등) 다른 경우
여러 규칙들이 AND
-> Operation 기준으로 필터링
-> WriteFile, RegSetValue, SetBasicInformationFile

CF) 시스템 타임 변조 후 공격 케이스
$MFT, $LogFile, $UsnJrnl($J)
-> keyword: USN 값
-> 운영체제가 발급해주는 값 -> 무조건 증가
USN값과 시스템타임을 비교해서 달라지는 부분


-----------------------------------------------------------------------------------------------

1. 사용자 인터뷰 - 사건 발생 이전에 무엇을 했는지 확인해야함. 어떤 업무, 어떤 사이트, 어떻게 인지 -> 유입경로 빠르게 식별
2. coc -> 증거를 합법적으로 뽑아냈는가를 기준으로 법적 증거로 채택
3. 악성코드 분석 과정에서 의미가 없는 행위는 없다. 예) google.com 으로 연결해서 인터넷 연결을 확인, 그 이후 c2 서버로 데이터 송신 등
4. 난독화가 되어 있지 않으면 entropy가 3점대, 부분적으로 난독화 되어 있으면 6, 그리고 7 이상이면 난독화가 되어있다고 봄. = 난독화 징후
5. 악성코드 유사성 해시 : imphash, ssdeep.
imphash : IAT 테이블을 기반으로 해시 생성
ssdeep : 바이너리 블록을 기반으로 해시 생성

6. 윈도우 기반 메모리 구조
stack - heap - program image - 예약된 영역 - DLL - TEB - PEB
 program image => text - data 등등

일반적으로 사용하는 라이브러리 목록 : kernel32.dll, ntdll.dll, user32.dll

7. die -> 어떤 언어로 악성코드가 작성되어 있는가를 확인용
나머지는 pestudio

8. hashtab -> 해시 확인용

9. sysmon 설치 방법 = cd Desktop > Sysmon.ext -i -n -h sha256
이건 미리 설치해놔야함

10 . process explorer = 악성코드 분석 시 프로세스 확인
작업관리자 보다 이걸 더 쓰며, 프로세스의 부모 자식 관계를 확인하기 위해 사용함
view -> scroll to new process = 새로운 프로세스 실행 시 자동으로 그쪽으로 감. 악성코드 분석 시 사용

11. autoruns = 악성코드가 지속성을 위해 자동으로 실행할 때, 지속성들을 확인할 수 있는 툴
악성코드는 description이 이상하거나 publisher이 없다. 이걸로 악성코드 여부를 확인
자동으로 실행되지 않아야 하는데 여기서 식별된다면 악성일 가능성이 높음. 예) chrome.exe

깨끗한 상태에서 save 후, 악성코드를 실행 했을 때와 비교분석

12. Regshot = 레지스트리 비교 유틸리티
일단 1shot을 누르고, 악성코드 실행 후 2shot을 실행

13. process moniter, explorer은 usb에 담아서 분석하는 곳에서 실행

14. process explorer -> create dump -> create full dump

findstr로 도메인/IP 찾기
findstr /I /R .*\..*\..*\..* cmd.dmp > result.txt
strings 툴 이용하는 방법
- strings cmd.dmp | findstr /i .*\..*\..*\..* > result.txt

15. <Sysmon으로 이벤트 분석>
응용 프로그램 및 서비스 로그 - microsoft - windows - sysmon

16. process monitor 와 sysmon 만으로도 충분한 데이터를 얻을 수 있음

procmon - tool - process tree - include subtree 

<Procmon>
CF) 필터 규칙
Column 이름(PID, Operation 등) 동일한 경우
여러 규칙들이 OR
Column 이름(PID, Operation 등) 다른 경우
여러 규칙들이 AND
-> Operation 기준으로 필터링
==> WriteFile, RegSetValue, SetBasicInfomationFile

17. <침해사고 분석>
%APPDATA% > Local > Microsoft > Windows > Temporary Internet Files

findstr /s "eval(" *.js > result.txt

js 분석 -> beautifier.io

eval -> consol.log 변환 후 chrome 개발자 도구 console 이용해서 결과 출력 가능

랜섬노트가 만들어진 시점을 기준으로 파일을 타임라인 별로 몇분 정도로 설정하여 파일을 분석.
단, 공격자가 시간을 두어 며칠, 몇주 뒤에 실행시키도록 설정한다면 확인해야 할 파일이 증가함

18. usb 드라이브를 통한 침해사고
 > 이벤트뷰어 로그 확인
 > C > Windows > System32 > winevt > Logs > Microsoft-Windows-Partition%4Diagnostic.evtx

19. 시스템 타임 변조 후 공격 케이스

$MFT, $Logfile, UsnJrnl($J)

-> NTFS Log Tracker를 이용해서 parse -> 결과 excel로 내보내기
결과의 USN 값은 절대 변조 불가함. USN 숫자가 클수록 늦게 만들어진 파일임
즉, USN 값이 증가하는데 타임스탬프가 갑자기 작아지는게 있다면 타임 스탬프 값을 변조한 것임

-> keyword : USN 값. 운영체제가 발급해주는 값으로 무조건 증가.
FTK Imager
=> $MFT, $Logfile, UsnJrnl($J) 추출
NTFS Log Tracker
=> 파일 정보를 추출
