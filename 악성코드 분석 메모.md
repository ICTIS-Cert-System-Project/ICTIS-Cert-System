시나리오
피해자의 컴퓨터 배경화면이 바뀌고 파일이 열리지 않음. -> 랜섬웨어 가능성
피해자는 웹서핑 중이었음. -> DBD 가능성


192.168.200.47

 

<침해사고  PC 조사>
1. 인터뷰 후 파일경로 확인
C:\Users\Administrator\AppData\Local\Microsoft\Windows\Temporary Internet Files


2. 타임라인 분석
-> READ_IT.txt(랜섬노트) 수정한 날짜 확인
-> html, js 파일 추출

+ 새폴더로 백업 
내 컴퓨터에서 수정된 날짜 "2019-07-18" 검색

 

3. 악성 스크립트 추출
-> findstr /s "eval(" *.js > result.txt                          /js 파일을 result.txt에 추출하여 출력


4. 악성자바스크립트 분석
-> https://beautifier.io                                               /악성자바스크립트를 가독성이 좋도록 코드 정렬
-> 콘솔창에서 자바스크립트 붙여넣기가 안 되는 경우
-> 개발자도구(F12) -> F1 -> Threat code evaluation as user action 확인

 

 

(숨김 파일 표시)
svchost.exe
local


악성코드에서 entropy(엔트로피)는 난독화 여부를 봄.
4점 이상 ~5점대 부분 난독화
7점 이상 ~8점대 난독화

난독화: 코드 난독화는 프로그래밍 언어로 작성된 코드에 대해 읽기 어렵게 만드는 작업.
감시나 데이터 수집을 방해하기 위해 모호하거나 헷갈리거나 호도하는 정보를 고의적으로 섞어 넣는 것을 말함.
대표적인 사용 예로는 프로그램에서 사용된 아이디어나 알고리즘 등을 숨기는 것 등. 


<악성코드 분석>

pestudio - 518.exe 파일 오픈

<설정>
자동 업데이트 사용하지 않음
사용자 계정 컨트롤 설정 낮추기
방화벽 해제

cmd - 관리자 권한 실행 
C:\Users\kisec_edu\Desktop>sysmon.exe -i -n -h sha256

- 악성코드 유사성 해시: imphash, ssdeep
- 프로그램이 동작할 때 꼭 필요한 라이브러리: kenrner32.dll, user32.dll, ntdll.dll
CF) GetProcAddress(), VirtualAlloc(), LoadLibraryA()
- 윈도우 기반 메모리 구조
stack - heap - program image(text, data, ...) - 비할당된 영역 - DLL - TEB - PEB
CF) TEB(Thread Environment Block), PEB(Process Enviroment Block)

- 악성코드 동적 분석

Sysmon
Regshot
Procmon
518
Autoruns
proexp

 

의심되는 동작 프로세스를 확인하기 전 기본 윈도우 프로세스를 알아야 함.

기본적으로 동작하는 윈도우 프로세스

 

System
csrss.exe
wininit.exe
services.exe
svchost.exe
winlogin.exe
explorer.exe

etc

부모 프로세스 - 자식 프로세스 간의 관계를 알아야 함.

의심되는 프로세스
cmd.exe - 윈도우 밖에서 동작
conhost.exe를 꺼도 독립적으로 실행

cmd.exe -> Create Full Dump -> cmd.dmp 저장


DLL Injection : 다른 프로세스에 특정 DLL 파일을 강제로 삽입시키는 것임.

result.txt 도메인에 은행 관련 도메인이 많은 것을 보고 인포스틸러, banker일 가능성이 있음.

 

 

(1) Sysmon
cmd(관리자 권한)- "sysmon.exe -i -n -h sha256"
로그 확인: 이벤트 뷰어 - 응용프로그램 및 서비스 로그 - Microsoft - Windows - Sysmon - Operational

ID 1: Process Create
ID 5: Process Terminate
ID 3: Network Connection

 

 

(2) Promon
AutoScroll 버튼 활성화(새로운 이벤트 실시간 확인)

<메모리에서 문자열 지표 찾기>
공격자의 IP 혹은 도메인 (필요)
- strings cmd.dmp | findstr /i /r .*\..*\..*\..* > result.txt         (cmd)

<Promon으로 이벤트 찾기>
필터 규칙
-> Column 이름(PID, Operation 등) 동일한 경우
여러 규칙들이 OR
-> Column 이름(PID, Operation 등) 다른 경우
여러 규칙들이 AND
-> Operation 기준으로 필터링
-> WriteFile, RegSetValue, SetBasicInformationFile

CF) 시스템 타임 변조 후 공격 케이스
$MFT, $LogFile, $UsnJrnl($J)
-> keyword: USN 값
-> 운영체제가 발급해주는 값 -> 무조건 증가
USN값과 시스템타임을 비교해서 달라지는 부분


-----------------------------------------------------------------------------------------------

