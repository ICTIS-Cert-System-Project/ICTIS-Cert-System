# 웹쉘 헌팅 *(Hunting Webshells)* 

##### 링크: [Hunting Webshells: Linux and Windows Commands][webshelllink]
[webshelllink]: https://library.mosse-institute.com/articles/2022/06/hunting-webshells-linux-and-windows-commands/hunting-webshells-linux-and-windows-commands.html "Go webshell"
##### 작성자: 강하늘 사원
##### 작성일자: 2024년 4월 7일


## 웹쉘(Webshell)의 정의
- 공격자가 서버에 원격으로 접근하기 위해 사용하는 악성 스크립트임.
  + 예를 들면 웹쉘을 이용해 임의의 명령을 실행하고, 파일을 업로드 및 다운로드 하거나 리버스 쉘(Reverse Shell) 연결을 설정하는 데에도 사용할 수 있음.
 
## 소개
- 로그 분석은 웹쉘\(Apache, IIS 등)을 탐색하는 데 사용되는 기술 중 하나임.
- 웹쉘 로그 분석에 많은 시간을 투자하지 않고, Log Parser Studio 도구를 사용하여 이전 섹션에서 언급한 도구와 기본 내장 OS 명령 및/또는 스크립팅 언어를 포함한 IIS 웹 로그를 분석하여 웹 서버의 디렉토리에서 숨겨진 웹쉘을 찾을 것임.

</br>

- 실제 도구로 넘어가기 전에 웹쉘을 찾기 위한 몇가지 기본적인 Linux 웹 서버 명령을 살펴보겠음.
- _알아둬야 할 것은 이 방법이 웹쉘을 찾기 위한 유일한 방법은 아님._
- _웹쉘을 찾는 방법들 중 몇가지만 다룰 것임._



</br>

- 다음 절에서는 특정 리눅스 웹 서버에서 4개의 웹 셸을 찾는 방법과 도구를 살펴봄.
  * 두 개의 파일은 난독화되지 않고 다른 두 개의 파일은 난독화됨.
  * 또한, 두 개의 파일에는 .php 파일 확장자가 있고 두 개의 웹 셸에는 .txt 파일 확장자가 있음.
- 이는 완료 및 성공적인 탐지를 위해 수행됨.

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/164521627/947a1829-1c63-490a-a051-397cf133e05c)

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/164521627/8d2bcf47-41c6-4519-ac31-053a5dfca952)

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/164521627/270f4d93-97f0-4ae9-9f75-774818276718)

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/164521627/3dfd07bd-418f-4a9a-937b-56911603abe1)

- 이전 사진에서 다음 웹쉘이 서버에 있는 것을 볼 수 있음.
    * locus7s.php (/var/www/html/)
    * unknown.txt (/var/www/html/js/)
    * ss8.txt (/var/www/html/images/)
    * unknown2.php (/var/www/html/css/)

## 리눅스 명령
- 다음 명령은 지난 24시간 이내에 웹 서버에 업로드된 새 파일을 찾을 것임.
- 사용자 환경의 웹 서버에서 매일 웹쉘 검사를 수행하는 경우 유용함.

  `find . -type f -name '*.php' -mtime -1`

  
  ![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/164521627/2feeb249-4d50-49f7-8818-5aa60030e658)

- 앞의 명령을 사용하여 Linux는 24시간 이내의 모든 PHP 파일('*.php')을 현재 디렉터리(.) 내에서 검색하도록 지시함.
- \-mtime 파일 속성은 파일이 마지막으로 수정한 시간과 날짜를 저장함(속성 자체가 아닌 내용만 저장).

</br>

- 이 정보는 다음 명령을 사용하여 볼 수 있음: </br>
`ls -l`


- txt 파일이나 해당 문제에 대한 모든 파일에 대해 동일한 작업을 수행할 수 있음: </br>
`find . -type f -name '*.txt' -mtime -1`


![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/164521627/faf28069-3d26-4a8c-8501-1bfacc5f3edd)


- 앞의 명령은 파일 내에서 아무것도 검사하지 않음.
- 검색된 위치에서 파일 내용의 마지막 수정 시간만 확인함.

</br>

- 파일 내에서 의심스러운 코드를 찾아내는 몇 가지 리눅스 명령어를 살펴보겠음.



- 파일 내에서 의심스러운 코드를 찾기 위해 xargs 및 grep을 사용하여 기존 Linux 명령을 수정함.

</br>

- 간략한 설명: </br>
    xargs - 표준 입력을 기반으로 명령줄을 생성하고 실행함. </br>
    grep - 패턴과 일치하는 행을 표시함.



- 이 명령은 PHP eval() 함수의 인스턴스를 검색함.
- 다음 명령을 실행하여 PHP 웹쉘을 검색할 것임.
`find . -type f -name '*.php' | xargs grep -l "eval *("`


![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/164521627/cf212861-640d-4f98-9d72-715e3c62b505)


- php 파일이 아닌 txt 파일을 검색하면 이전과 동일한 결과를 얻을 수 있음:
`find . -type f -name '*.txt' | xargs grep -l "eval *("`


![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/164521627/c41f4479-005d-4468-a145-2578c7df0b38)

## Windows 명령 
