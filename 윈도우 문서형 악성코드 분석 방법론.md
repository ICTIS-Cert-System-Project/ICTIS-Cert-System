# 윈도우 문서형 악성코드 분석 방법론
##### 작성자 : 김평일 대리, 정한울 대리, 김태현 사원, 강하늘 사원
##### 작성일자 : 2024년 6월 1일
</br></br>

## (1) 문서 파일 개요

## (2) 한글 파일 개요

## (3) PDF 파일 개요

### 3-1 PDF 파일 구조

PDF의 구조는 다음과 같이 구성되어 있음. 시그니처 및 버전을 나타내는 Header와 PDF문서의 내용이 들어가 있는 Body, 객체들이 참조할 때 사용되는 정보가 있는 Xref Table, 그리고 파일 구조를 추적할 수 있는 File Trailer가 존재함.

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/abea70d1-088c-4461-bd8d-efee550e11a3)

## (4) 문서 파일 분석 도구
### 4-1 pdfid

pdfid는 pdfid.py 형태로 존재하며, PDF의 악성 여부를 신속히 식별하기 위해 특정 키워드를 찾는 "키워드 검색 도구"임. 이를 통해 PDF파일 내에 자바스크립트 랙션, 삽입된 파일 등 잠재적으로 위험한 요소가 있는지 검사할 수 있음.

다운로드 링크 : https://pypi.org/project/pdfid/ , 혹은 `pip install pdfid`, 혹은 `sudo apt install pdfid`

악성 키워드는 다음과 같음.

- /OpenAction, /AA : 문서를 열 때 액션을 트리거
- /JavaScript, /JS, /AcroForm, /XFA : 자바스크립트 코드 지정 및 실행
- /URL : 외부 URL 접근
- /SubmitForm, /GoToR : 외부 URL로 데이터 전송
- /RichMedia : 문서에 플래시 삽입
- /ObjStm : 객체 스트림에 데이터 숨김
- /XObject : 피싱 이미지 삽입
- /EmbeddedFile : 스트림에 외부 파일 삽입

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/44c3bef6-165e-434f-897f-520ed006c99f)

상기 언급한 키워드를 발견했을 경우, 해당 키워드에 대한 객체 ID룰 찾고 그 내용을 덤프하여 세부 내용을 조사해야함.

### 4-2 peepdf

peepdf는 PDF파일을 심층 분석할 수 있도록 설계된 포렌식 도구임. PDF 문서의 객체와 스트림(키워드)를 상세히 탐색하고 악성 요소를 식별할 수 있도록 함.

다운로드 링크 : https://pypi.org/project/peepdf/0.3.2/, 혹은 `pip install peepdf==0.3.2`

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/6c09adcc-79c2-4ee4-a8b5-d07afa753a91)

실행하면 다음과 같이 PDF에 대한 메타데이터를 확인할 수 있음. 가장 중요한 부분은 악성 스트림에 대한 오브젝트 넘버를 확인할 수 있는 부분임.

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/34254108-aa8b-4d6f-acad-ac87ea1d35e0)

탐지한 악성 스트림에 대한 오브젝트를 살펴 보면 다음과 같이 악성 행위를 탐지할 수 있음.

### 4-3 pdf-parser

pdf-parser는 PDF 문서에서 데이터를 식별하고 추출하며 덤프할 수 있는 도구임. pdfid와 peepdf로 의심스러운 객체 ID가 식별되면, pdf-parser를 사용하여 의심스러운 객체 콘텐츠를 덤프할 수 있음.

다운로드 링크 : https://pypi.org/project/py-pdf-parser/, 혹은 `pip install py-pdf-parser`

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/f792f868-bd5a-43d8-88ec-0094f7fd50de)

`pdf-parser.py -o 50 --raw -f <파일 이름>`

다음과 같이 객체 50에 대한 세부 정보가 표시됨. 추가로, 해당 객체를 txt 형식으로 다음과 같이 덤프할 수 있음.

`pdf-parser.py -o 50 --raw -f 파일 이름 > result.txt`

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/e3df216d-2dae-48ae-a5c6-335e6786a306)

### 4-4 REMnux

REMnux는 리버스 엔지니어링 및 악성코드 분석 시 필요한 도구와 툴킷들이 포함되어 있는 리눅스 기반 배포판임. 위에서 언급한 도구들이 기본적으로 탑재되어 있어, 별도의 설치 필요없이 분석 환경을 구성할 수 있음. 악성코드는 기본적으로 가상환경에서 분석을 진행해야 하므로 REMnux에서 분석을 진행할 것을 권장함.

다운로드 링크 : https://remnux.org/

## (5) PDF 악석코드 샘플 분석 1
위에서 설명한 도구를 이용하여 샘플을 분석하는 프로세스를 설명함. 해당 샘플은 URL 기반 조사임.

### 5-1 pdfid를 이용한 의심스러운 객체 식별

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/61167d9a-f3b8-44bc-930e-4b607b426585)

pdfid로 악성 PDF를 조사한 결과, /URL에 대한 키워드가 26개 발견됨. /URL 키워드는 외부 URL 접근을 의미하므로 악성 행위가 의심됨.

### 5-2 peepdf를 이용한 /URL 객체 ID 식별

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/9d7925c9-38bd-4ec9-ac90-0e64424788fc)

peepdf를 이용하여 /URL의 객체 ID를 식별함. 여기서는 10,17,18,19,20,21,22,23,24,25,26,27,28에 해당하는 것을 알 수 있음.

### 5-3 pdf-parser를 이용한 URL 특정하기

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/90c040ec-3140-4ad7-81fa-db3a811a0230)

pdf-parser를 이용하여 /URL 객체 ID에 대한 데이터를 추출할 수 있음.

`pdf-parser.py -o 10,17,18,19,20,21,22,23,24,25,26,27,28 <파일 이름>`

다음과 같이 URL이 확인됨을 알 수 있고, virustotal 또는 기타 분석 도구를 사용하여 악성 여부를 판단할 수 있음.

## (6) PDF 악성코드 상세 분석
invoice-019338.pdf에 대한 상세 분석 프로세스임

`파일 정보`

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/e545a40a-3a59-4fff-9f17-cbcd4226febb)


### 6-1 PDF 내부 의심스러운 키워드 찾기

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/cbfb40a0-9afe-4c21-982a-a64205288211)

pdfid를 이용하여 의심스러운 키워드를 찾으면 다음과 같음. 의심스러운 키워드로는 /JS가 2개, /JavaScript가 3개, /OpenAction이 1개 존재함.
즉, 이 PDF 파일에는 자바스크립트가 존재하고, 해당 PDF 문서를 열어봄과 동시에 무엇인가 행위를 트리거하도록 구성되어 있음을 파악할 수 있음.

### 6-2 PDF 파일 내 객체 ID 분석

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/15bb5537-9d64-4d0b-9a4d-7620e0fa4aa9)

`$ pdf-parser.py --search /OpenAction inovoice-019338.pdf`

PDF 문서를 열면 가장 먼저 /OpenAction 키워드에 정의되어 있는 스크립트가 실행됨. 위 이미지와 같이 function11\\(\\) 함수가 실행됨을 알 수 있으나 자세한 스크립트는 확인이 불가능함. 이를 확인하기 위해서는 obj 12가 참조하고 있는 obj 7, 11을 확인해야함.

Referencing : 7 0 R, 11 0 R을 통해 참조 여부를 확인할 수 있음

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/8453ca8d-b41d-46ab-84ba-c4e4ce9315b6)

`$ pdf-parser.py --search /JavaScript inovoice-019338.pdf`

obj 12에서 실행되는 스크립트가 자바스크립트임을 확인했기 때문에 /JavaScript 키워드를 기반으로 검색함. 검색 결과 obj 7도 obj 10을 참조할 수 있음을 알 수 있고, obj 12에서도


