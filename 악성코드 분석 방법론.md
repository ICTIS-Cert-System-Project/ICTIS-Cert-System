# 악성코드 분석 방법론
##### 작성자 : 김평일 대리, 김태현 사원
##### 작성일자 : 2024년 5월 23일
</br></br>

## (1) 분석 개념


## (2) 분석 도구

### 2-1 Sysmon

Sysmon은 System Monitoring의 줄임말로, 윈도우의 로그를 분석하는데 가장 일반적으로 사용되는 추가 도구 중 하나임. Sysmon을 사용하면 코드 동작과 네트워크 트래픽을 추적하여 악성 활동을 탐지할 수 있음

Sysmon은 현재 마이크로소프트가 소유하고 있는 패키지의 일부이며 별도의 다운로드와 다음과 같은 설치 과정을 거쳐주어야 함

다운로드 링크 : https://learn.microsoft.com/ko-kr/sysinternals/downloads/sysmon

`Sysmon.exe -i -n -h sha256`
- -i : Sysmon을 설치하라는 명령어
- -n : 네트워크 연결 모니터링을 활성화하는 옵션
- -h sha256 : 파일 생성 및 이미지 로딩 이벤트를 로깅할 때 sha256 알고리즘을 사용할 것을 지정

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/704f5832-6973-424a-8556-67b809818766)

Sysmon 활용 방법임. (1)"이벤트 뷰어"를 오픈한 후 "응용 프로그램 및 서비스 로그 - Microsoft - Sysmon" 항목을 찾아서 "Operational" 항목을 클릭함.

Operational 항목을 선택하면 우측에 (2)날짜와 시간 순으로 Sysmon이 기록한 로그 정보가 표시되며, 특정 로그를 선택할 경우 하단의 (3)일반 항목에 세부 정보가 출력됨.

참고로, 이벤트 ID 별 상황은 다음과 같음.

(중요)<br>
ID 1 : Process Create - 프로세스 생성 시 발생<br>
ID 3 : Network Connection - 네트워크 연결 시 발생<br>
ID 5 : Process Terminate - 프로세스 종료 시 발생


### 2-2 Regshot

Regshot은 레지스트리의 스냅샷을 신속하게 촬영한 다음, 시스템 변경을 수행하거나 새 소프트웨어 제품을 설치한 후 수행되는 두 번째 스냅샷과 비교할 수 있는 오픈소스 레지스트리 비교 유틸리티임.

악성코드의 동적분석 시 활용되며, 악성 행위가 실행되기 전에 스냅샷을 찍고, 악성 행위가 실행된 후의 스냅샷을 찍어 이를 비교해 레지스트리의 수정 정보를 확인함.

다운로드 링크 : https://sourceforge.net/projects/regshot/

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/56c93c58-035f-4bd9-bc48-020df1cd3aea)

Regshot을 실행하고, 1st shot과 2nd shot을 각각 클릭해서 레지스트리 파일을 두개 생성함. 이후 Compare을 클릭하여 변경된 부분을 확인

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/f121bb72-a86e-4c89-948a-665912e98d8e)


### 2-3 Procmon

Procmon은 Process Monitor의 줄임말로, 프로세스의 분석과 디버깅을 하기 위해 레지스트리, 파일, 프로세스, 네트워크 동작 등을 **실시간으로 캡처하는 프로그램임**

다운로드 링크 : https://learn.microsoft.com/ko-kr/sysinternals/downloads/procmon

프로세스들 중, 검색하고자 하는 특정 프로세스만 필터링 할 수 있음

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/4207b45c-293d-4ca2-bbe6-66318905fd02)

디폴드 필터를 모두 삭제 후

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/b41c9e59-8794-4fea-8270-58a9b538b2a2)

모니터링 대상 프로세스의 이름을 입력함.

Process Name 선택, is 선택, (대상 프로세스) 입력, Include 선택, Add 클릭

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/1b93558c-336b-4e76-8659-34776f389e80)

이후 수집한 로그를 외부로 내보내기하여 세부적인 분석을 수행할 수 있음.

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/89b30301-3bf2-4224-8281-ec5f76558b14)

또한, AutoScroll 버튼을 활성화하여 새로운 이벤트를 실시간으로 확인할 수 있으며, tool - process tree - include subtree를 활성화하여 트리 구조를 확인할 수 있음.

cf) 필터 규칙 : Column 이름(PID, Operation 등) 동일한 경우 여러 규칙들이 OR Column 이름(PID, Operation 등) 다른 경우 여러 규칙들이 AND -> Operation 기준으로 필터링 ==> WriteFile, RegSetValue, SetBasicInfomationFile


### 2-4 Autoruns

Autoruns는 msconfig.exe의 확장된 도구로, 윈도우 시스템이 부팅 후 자동으로 시작되는 서비스 또는 프로그램 등을 모니터링 할 수 있는 도구임.
특정 악성코드의 경우 cmd.exe를 자동으로 실행시켜 프로세스를 유지하기에 이를 탐지하고 조치할 수 있음.

악성코드가 지속성을 위해 자동으로 실행할 때, 악성코드는 description이 이상하거나 publisher이 없음. 프로세스가 자동으로 실행되지 않아야 하는 상황에서 인증되지 않은 프로세스가 식별된다면 악성일 가능성이 높음.

악성코드가 실행되지 않은 환경에서 save 후, 악성코드를 실행 했을 때와 비교분석을 진행함.

다운로드 링크 : https://learn.microsoft.com/en-us/sysinternals/downloads/autoruns

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/a3dedf6a-ec43-49c0-a6b6-6c6d9e2022bc)

다음과 같이 활성화된 프로세스 목록을 확인할 수 있음

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/eb5bd167-af3a-4aba-95a5-b2596656faf4)

상단 option의 Hide Microsoft Entries 옵션을 통해 마이크로소프트의 기본 프로세스를 숨길 수 있음. 이는 악성코드를 분석하는데 있어 복잡함을 덜기 위함임. 검색되는 항목 중 게시자가 Microsoft Corporation이면 숨김 처리가 됨.

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/3805f490-c627-4a41-8109-d7db8014b5bf)

그러나 프로그램 게시자는 얼마든지 임의로 수정이 가능함. 그러므로 options - scan options - verify code signatures를 활성화하여 디지털 서명을 검증하는 작업을 진행할 수 있음.




### 2-5 Procexp

Procexp는 Process Exploer의 줄임말로, 윈도우 시스템 모니터링 유틸리티임. 실행중인 프로세스 목록 및 트리를 확인할 수 있음. 이를 통해 프로세스가 점유하고 있는 자원들을 한 눈에 볼 수 있으며, 프로세스가 동작하는 경로, 라이브러리, 레지스트리를 확인할 수 있음.

악성코드 분석 시 프로세스 확인을 위해 작업관리자보다 Procexp를 더 쓰는 편임. 가장 주요하게 모니터링하는 부분은 프로세스의 부모 자식 관계임.

다운로드 링크 : https://learn.microsoft.com/ko-kr/sysinternals/downloads/process-explorer

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/7b5252a8-4f56-4252-9156-bb73f6547760)

프로그램을 실행했을 때 기본적으로 확인할 수 있는 화면으로 현재 실행 중인 프로세스를 모니터링할 수 있음. GUI 화면으로 프로세스 트리를 확인할 수 있어 구조를 쉽게 파악할 수 있음.

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/950db592-f38b-4e30-b60e-0fdcc55c50c4)

해당 프로세스를 클릭하여 프로세스 핸들, DLL(라이브러리), 쓰레드 정보도 확인할 수 있음. 비정상 프로세스를 분석하는데 있어 중요한 정보들임.

추가로, view - scroll to new process를 활성화라여 새로운 프로세스 실행 시 자동으로 해당 프로세스를 따라가도록 설정할 수 있음.

### 2-6 DIE

DIE는 Detect It Easy의 줄임말로, 어셈블리 패턴과 PE 헤더의 IAT를 분석하여 사용된 컴파일러를 추정하는 프로그램임. 난독화 솔루션을 사용했을 때에도 어떤 난독화 프로그램을 사용했는지 표시됨.

*IAT란, Import Address Table로 PE 파일이 사용하는 외부 API 함수의 주소들을 배열 형태로 저장해놓은 영역을 의미함.

*PE파일 종류
실행 계열 - EXE, SCR
라이브러리 계열 - DLL, OCX, CPL, DRV
드라이브 계열 - SYS, VXD
오브젝트 계열 - OBJ

다운로드 링크 : https://github.com/horsicq/DIE-engine/releases

![image](https://github.com/ICTIS-Cert-System-Project/ICTIS-Cert-System/assets/18510716/b42a4adc-2d9c-4e00-860c-241919631676)

다음과 같이 분석이 가능함. 컴파일러와 프레임워크 추정 결과 C++ MFC를 사용한 프로그램임을 알 수 있음.

DIE로는 어떤 언어로 작성되었는지를 주로 확인하고, 나머지는 아래에서 설명할 Pesrudio를 사용하여 분석함.

### 2-7 Pestudio






### 2-8 Hashtab

